# ubuntu和windows双系统

最近又有装双系统的念头，我曾经装过双windows，也装过linux+windows，现在计划改成win10 + win11 + ubuntu 下面是我的思考过程。

1. 打apex太卡了，我觉得是目前的win11系统不够纯净导致的，我装了很多日常用的和开发用的软件，我应该安装一个win10+linux的双系统。
2. 看了一些网上的测试之后发现 win11 和 win10 在游戏性能上难分伯仲，和不同游戏各自的优化有很大的关系，换成win10也未必就能提升apex帧数。
3. 另外根据以前的经验， linux 在日用体验上有很多各种各样不方便的小毛病需要自己找办法解决：已经解决的比如输入法，比如更换桌面环境；没有自己解决过的比如字体渲染，比如双系统切换会导致时间异常，比如浏览网页触摸板速度异常等等。
	1. 当然这些问题肯定都是可以解决的，只是需要成本。
4. 而且如果说 linux 用来工作，不需要优化太多体验细节，能跑就行，win10 也只用来打游戏，那日常使用电脑用什么系统呢？如果用win10，最后系统还是会装各种各样的软件，如果再装一个新系统，三系统切换又非常麻烦，这背后的核心原因是我的娱乐和生活是有重合的，生活和工作也是有重合的。
5. 最终的方案是当前系统仍然作为主力系统运行很多杂七杂八的东西，只把两个比较纯粹的和生活无关的需求拆解成两个精简系统，一个是纯粹打apex的win10，一个是纯粹工作的ubuntu。

---

## 无usb安装win+ubuntu双系统

参考 [system installation - How can I install Ubuntu without CD and USB? - Ask Ubuntu](https://askubuntu.com/questions/484434/how-can-i-install-ubuntu-without-cd-and-usb)，使用`For UEFI devices`方案。

第一步，下载[refind](http://sourceforge.net/projects/refind/files/)并解压，refind是一个boot manager。

第二步，用diskgenius把解压了的refind目录复制到ESP分区的EFI目录下（`S:\EFI\refind`，这个refind目录下需要有`refind_x64.efi`、`refind.conf-sample`等文件）

然后把`S:\EFI\refind`里的`refind.conf-sample`改名为`refind.conf`。

第三步，打开一个有管理员权限的cmd,执行：
```batch
:: S: 表示ESP分区，`/S`表示给该分区添加一个S盘符。
:: 不确定这一步是不是必要的
mountvol S: /S

:: cd到refind目录，不确定这一步是不是必要的
cd S:\EFI\refind

:: 编辑系统引导为这个refind的efi文件，如果是非x64的自己选择它类型的。
bcdedit /set {bootmgr} path \EFI\refind\refind_x64.efi
```

这一步会修改windows使用refind作为系统引导。

第四步，创建一个4G左右的fat32分区，然后把系统iso解压进去，这个分区将作为liveCD。

第五步，重启电脑就会进入refind，选择这个liveCD即可。

## 开始

安装ubuntu的时候语言选择汉语，就会自动安装一个中文输入法。

1. **安装梯子**：firefox 用bing搜索 sparkle mihomo party，安装sparkle
2. **安装qq**：官网上有deb包，用应用中心打开deb包就可以可视化安装，通过qq把手机上的梯子订阅链接传到电脑上。
3. **安装NVIDIA驱动**：通过[这篇博客](https://www.cnblogs.com/niuben/p/18397121)手动安装nvidia驱动，需要先安装`sudo apt install gcc make`。按理说开启了非自由软件之后ubuntu应该会自动给我安装nvidia驱动，不知道为什么没给我安装。
4. **其他软件**：有了梯子之后直接去软件各自的官网下载安装chrome，vscode，yazi，都有deb包，yazi是snap包，安装.snap的方式是 `sudo snap install <filename.snap> --dangerous`.




## 搜狗输入法

> 安装ubuntu的时候语言选择汉语，就会自动安装一个中文输入法，否则安装中文输入法对我来说是一个感受不到意义且非常困难的工作，下面的记录来自我曾经安装搜狗输入法的经验。
> 
> 另外我最近从[小众软件的一个分享帖](https://meta.appinn.net/t/topic/79602) 听说了一种新的输入方式，通过拼音+字形码来精准定位你要输入的文字，算是拼音和五笔的结合，对于每一个字，你可以选择是否要在拼音后面添加一个与字形有关的键来辅助确定该字，这个方案叫做[轻松码字](https://k.appinn.me/qing/)，我还没来得及尝试。

开启中文支持： Settings -> Region & Language -> Manage installed Languages -> Install / Remove Languages -> 点选 Chinese (simplified) -> Apply

添加拼音输入法： Settings -> Region & Language -> Input Sources -> + -> Chinese -> Chinese (Intelligent Pinyin)
如果没有拼音输入法 则可以`sudo apt install ibus-pinyin`

搜狗输入法官方提供了一个deb包，没有登录功能，安装这个deb包之后，在设置页面把输入法框架改为fcitx，然后安装搜狗的依赖：
```bash
sudo apt install libqt5qml5 libqt5quick5 libqt5quickwidgets5 qml-module-qtquick2
sudo apt install libgsettings-qt1
```
这时候重启应该就能够使用搜狗输入法了，但是可能会在终端可使用但是浏览器无法使用，需要补充安装一些东西：
```bash
sudo apt install *gtk4
```

1. 系统显示文字不必设置为中文，只需要下载中文的语言包即可。
2. ibus应该可以不删除，只要不要同时启动ibus和fcitx就好了。
3. 设置win+space切换输入法需要在设置里先关闭win+space的快捷键，然后在fcitx的设置里才能用。

## 浏览器异体字

解决办法参考 https://tieba.baidu.com/p/4879946717

大概原因是在英文的系统中，显示中文时，日语字体排在中文字体前面所以会显示异体字，需要手动调整顺序。
```bash
# 调整偏好顺序
sudo cat > /etc/fonts/conf.avail/64-language-selector-prefer.conf  <<EOF
<?xml version="1.0"?>
<!DOCTYPE fontconfig SYSTEM "fonts.dtd">
<fontconfig>
<alias>
<family>sans-serif</family>
<prefer>
<family>Noto Sans CJK SC</family>
<family>Noto Sans CJK TC</family>
<family>Noto Sans CJK JP</family>
</prefer>
</alias>
<!--以上为设置无衬线字体优先度-->
<alias>
<family>monospace</family>
<prefer>
<family>Noto Sans Mono CJK SC</family>
<family>Noto Sans Mono CJK TC</family>
<family>Noto Sans Mono CJK JP</family>
</prefer>
</alias>
<!--以上为设置等宽字体优先度-->
</fontconfig>
EOF

sudo ln -s /etc/fonts/conf.avail/64-language-selector-prefer.conf /etc/fonts/conf.d/64-language-selector-prefer.conf

# 如果存在 /etc/fonts/conf.d/64-language-selector-cjk-prefer.conf，把这个文件的内容也改成上面的xml

# 更新字体缓存
fc-cache -fv

# 检查字体匹配优先
# 如果显示的是"Noto Sans CJK SC" 则表示成功，如果不是CJK而是JP则仍然为异体字。
fc-match -s | grep NotoSansCJK-Regular.ttc 
```
## show apps按钮居左
`show apps`按钮类似windows的开始菜单，放在左下角习惯一点。下面这个写true就是左边，false就是右边。
```bash
gsettings set org.gnome.shell.extensions.dash-to-dock show-apps-at-top true
```

## 处理appimage

ubuntu下使用appimage双击无法直接打开，在终端执行appimage文件的时候提示需要FUSE，查看FUSE的[wiki](https://github.com/AppImage/AppImageKit/wiki/FUSE)发现ubutnu安装fuse的方法：
```bash
sudo add-apt-repository universe
sudo apt install libfuse2t64
```

但是appimage不会在“在系统中注册”，我们可以手动处理，或者使用自动注册appimage的工具。自动注册工具的可选项有AppImageLauncher和appimaged，试过了都不好用，不好处理sandbox。

手动处理参考
1. https://zhuanlan.zhihu.com/p/1923316954887873371
2. https://forum.cursor.com/t/tutorial-install-cursor-permanently-when-appimage-install-didnt-work-on-linux/7712

以安装cursor为例，第一步，创建一个cursor的应用目录，下载cursor appimage到这里
```bash
mkdir -p ~/app/cursor
```

第二步，给`cursor.AppImage`添加可执行权限
```bash
chmod +x cursor.AppImage
```

第三步，把[cursor图标](https://us1.discourse-cdn.com/cursor1/original/2X/f/f7bc157cca4b97c3f0fc83c3c1a7094871a268df.png)放到`~/app/cursor`目录下

第四步，创建一个desktop entry:
```bash
cat > ~/.local/share/applications/cursor.desktop <<EOF
[Desktop Entry]
Name=cursor
Exec=/home/qiudeng/app/cursor/cursor.AppImage --no-sandbox
Icon=/home/qiudeng/app/cursor/logo.png
Type=Application
Categories=Utility;Development;
EOF
```

然后在应用程序列表搜索cursor就可以搜到了。 这个desktop entry还可以放在桌面或者`/usr/share/applications`

